---
title: "san_francisco"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{san_francisco}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(USF)
library(sf)
library(tidyverse)
library(tmap)
library(ggplot2)
```

----

New data: Secured Property Tax Data from 2007/08 to 2020/21 tax year 
[Source](https://www.sfassessor.org/news-information/property-data-0)

```{r}
# read excel sheets
library(here)
library(readxl)

# read excel_sheet
excel_sheets(here("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/assessors/2019.8.20__SF_ASR_Secured_Roll_Data_2007-2008.xlsx"))

# specify worksheet 1 "Roll Data 2007-2008"

ptaxdata_0708 <- read_excel(
  here("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/assessors/2019.8.20__SF_ASR_Secured_Roll_Data_2007-2008.xlsx"), 
  sheet = "Roll Data 2007-2008")

# edit col 3

ptaxdata_0708[3] <-ptaxdata_0708[3] %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))

# 2012-13

ptaxdata_1213 <- read_excel(
  here("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/assessors/2019.8.20__SF_ASR_Secured_Roll_Data_2012-2013.xlsx"),
  sheet = "Roll Data 2012-2013")

ptaxdata_1213[3] <-ptaxdata_1213[3] %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))

# 2017-18

ptaxdata_1718 <- read_excel(
  here("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/assessors/2019.8.12__SF_ASR_Secured_Roll_Data_2017-2018.xlsx"),
                          sheet = "Roll Data 2017-2018")

ptaxdata_1718[3] <-ptaxdata_1718[3] %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))

# 2019-20

ptaxdata_1920 <- read_excel(
  here("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/assessors/2020.7.10_SF_ASR_Secured_Roll_Data_2019-2020.xlsx"),
                          sheet = "Roll Data 2019-2020")

ptaxdata_1920[2] <-ptaxdata_1920[2] %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))

# 2020-21

ptaxdata_2021 <- read_excel(
  here("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/assessors/2021.7.28_SF_ASR_Secured_Roll_Data_2020-2021.xlsx"),
                          sheet = "Roll Data 2020-2021")

ptaxdata_2021[2] <-ptaxdata_2021[2] %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))


```


Parcel data

```{r}
parcels <- st_read("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/Parcels/Parcels/sanfranparcel.shp")

# change name to match `ptdata_XXXX`

names(parcels)[1] <- "RP1PRCLID"

# attempt join

sf_0708 <- right_join(parcels, ptaxdata_0708, by = "RP1PRCLID") %>% st_as_sf()

sf_1213 <- right_join(parcels, ptaxdata_1213, by = "RP1PRCLID") %>% st_as_sf()

sf_1718 <- right_join(parcels, ptaxdata_1718, by = "RP1PRCLID") %>% st_as_sf()

sf_1920 <- right_join(parcels, ptaxdata_1920, by = "RP1PRCLID") %>% st_as_sf() 

sf_2021 <- right_join(parcels, ptaxdata_2021, by = "RP1PRCLID") %>% st_as_sf() 


```

Map? Works with `ggplot` but doesn't with `tmap` - need to fix bugs


```{r}

# quantile(ptaxdata_0708$RP1LNDVAL)
# sf0708_breaks <- c(1, 36370, 140186, 1475439, 256020000)

sd(ptaxdata_0708$RP1LNDVAL)


sf_1920 %>%
  ggplot(aes(fill = RP1LNDVAL)) + 
  geom_sf(color = NA) + 
  scale_fill_viridis_c(option = "magma", na.value = "light grey",
                       breaks = sf0708_breaks) +
  labs(title = "Assessed value of land 07/08")
```

Export `.SHP` for ArcOnline hosting

```{r}
# write SHP

#st_write(sf_0708, 
#         "~/Clark/RA-ing/SummerInstitute/USF/localdrive/sf_0708.shp", 
#         driver = "ESRI Shapefile")

# st_write(sf_1213,
#         "~/Clark/RA-ing/SummerInstitute/USF/localdrive/sf_1213.shp",
#         driver = "ESRI Shapefile")
# 
# st_write(sf_1718,
#         "~/Clark/RA-ing/SummerInstitute/USF/localdrive/sf_1718.shp",
#         driver = "ESRI Shapefile")
# 
# st_write(sf_1920,
#         "~/Clark/RA-ing/SummerInstitute/USF/localdrive/sf_1920.shp",
#         driver = "ESRI Shapefile")
# 
# st_write(sf_2021,
#         "~/Clark/RA-ing/SummerInstitute/USF/localdrive/sf_2021.shp",
#         driver = "ESRI Shapefile")

```

-----

Calls service - need address locator

```{r}
sf_calls <- read.csv("~/Clark/RA-ing/SummerInstitute/GIS/sanfran/Police_Department_Calls_for_Service.csv")
```

